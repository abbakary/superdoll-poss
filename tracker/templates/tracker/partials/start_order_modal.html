<!-- Unified Start Order Modal -->
<div class="modal fade" id="startOrderModal" tabindex="-1" data-bs-keyboard="false" data-bs-backdrop="static">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-primary border-3">
      <div class="modal-header bg-gradient text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <h5 class="modal-title">
          <i class="fa fa-play-circle me-2"></i>Quick Start Order
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" onclick="resetStartOrderForm()"></button>
      </div>
      
      <div class="modal-body" id="startOrderBody">
       

        <form id="startOrderForm" onsubmit="submitStartOrder(event)">
          <div class="mb-4">
            <label class="form-label fw-bold">Vehicle Plate Number <span class="text-danger">*</span></label>
            <input
              type="text"
              id="plateNumber"
              class="form-control form-control-lg text-uppercase border-2"
              placeholder="e.g., ABC 123 XYZ"
              required
              autofocus
              style="letter-spacing: 0.1em; font-weight: bold; font-size: 1.1rem;">
          
            <div id="plateCheckResult" class="mt-2"></div>
          </div>

        
        </form>
      </div>

      <!-- Loading State -->
      <div id="startOrderLoading" style="display: none;" class="modal-body text-center py-5">
        <div class="spinner-border text-primary mb-3" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="text-muted mb-2">Creating order...</p>
        <small class="text-secondary">Please wait while we initialize your order</small>
      </div>
      
      <div class="modal-footer bg-light d-flex justify-content-between">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" onclick="resetStartOrderForm()">
          <i class="fa fa-times me-1"></i>Cancel
        </button>
        <button type="button" class="btn btn-primary btn-lg px-5" onclick="submitStartOrder(event)" id="startOrderBtn">
          <i class="fa fa-play me-2"></i><span id="startBtnText">Start Order</span>
        </button>
      </div>
    </div>
  </div>
</div>

<script>
function resetStartOrderForm() {
  document.getElementById('startOrderForm').reset();
  document.getElementById('plateNumber').value = '';
  document.getElementById('startOrderBody').style.display = 'block';
  document.getElementById('startOrderLoading').style.display = 'none';
  document.getElementById('startOrderBtn').disabled = false;
  document.getElementById('startBtnText').textContent = 'Start Order';
  // reset plate check result
  const res = document.getElementById('plateCheckResult'); if(res) res.innerHTML = '';
}

function submitStartOrder(event) {
  event.preventDefault();

  const plateNumber = document.getElementById('plateNumber').value.trim().toUpperCase();
  const orderType = 'service';

  if (!plateNumber) {
    alert('Please enter a vehicle plate number');
    document.getElementById('plateNumber').focus();
    return;
  }

  // Validate plate format (basic)
  if (plateNumber.length < 5) {
    alert('Please enter a valid plate number');
    return;
  }

  // Check plate result choices
  const plateCheckEl = document.getElementById('plateCheckResult');
  let useExisting = false;
  let existingCustomerId = null;
  if (plateCheckEl && plateCheckEl.dataset && plateCheckEl.dataset.existing === 'true') {
    // If user selected to use existing, the button will have set data-use-existing
    useExisting = plateCheckEl.dataset.useExisting === 'true';
    existingCustomerId = plateCheckEl.dataset.existingCustomerId || null;
  }

  // Show loading state
  document.getElementById('startOrderBody').style.display = 'none';
  document.getElementById('startOrderLoading').style.display = 'block';
  document.getElementById('startOrderBtn').disabled = true;
  document.getElementById('startBtnText').textContent = 'Creating...';

  const payload = {
    plate_number: plateNumber,
    order_type: orderType
  };
  if (useExisting && existingCustomerId) {
    payload.use_existing_customer = true;
    payload.existing_customer_id = Number(existingCustomerId);
  }

  // Send API request
  fetch('{% url "tracker:api_start_order" %}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify(payload)
  })
  .then(response => response.json())
  .then(data => {
    // If backend found an existing customer for the plate, prompt the user first
    if (data.existing_customer) {
      showPlateExistingNotice(data.existing_customer, data.existing_vehicle);
      document.getElementById('startOrderBody').style.display = 'block';
      document.getElementById('startOrderLoading').style.display = 'none';
      document.getElementById('startOrderBtn').disabled = false;
      document.getElementById('startBtnText').textContent = 'Start Order';
      return;
    }

    // Proceed only when an order was actually created
    if (data.success && data.order_id) {
      const modal = bootstrap.Modal.getInstance(document.getElementById('startOrderModal'));
      modal.hide();
      setTimeout(() => {
        window.location.href = `/orders/started/${data.order_id}/`;
      }, 300);
      return;
    }

    // Otherwise, show error and keep the form visible
    document.getElementById('startOrderBody').style.display = 'block';
    document.getElementById('startOrderLoading').style.display = 'none';
    document.getElementById('startOrderBtn').disabled = false;
    document.getElementById('startBtnText').textContent = 'Start Order';
    alert('Error: ' + (data.error || 'Failed to start order'));
  })
  .catch(error => {
    console.error('Error:', error);
    document.getElementById('startOrderBody').style.display = 'block';
    document.getElementById('startOrderLoading').style.display = 'none';
    document.getElementById('startOrderBtn').disabled = false;
    document.getElementById('startBtnText').textContent = 'Start Order';
    alert('Error starting order. Please try again.');
  });
}

// Plate check helper
function checkPlateExists() {
  const plateNumber = document.getElementById('plateNumber').value.trim().toUpperCase();
  if (!plateNumber || plateNumber.length < 5) return;

  fetch('{% url "tracker:api_check_plate" %}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify({ plate_number: plateNumber })
  })
  .then(r => r.json())
  .then(data => {
    if (data.found) {
      showPlateExistingNotice(data.customer, data.vehicle);
    } else {
      // clear plate check data
      const res = document.getElementById('plateCheckResult');
      if(res) { res.innerHTML = ''; res.dataset.existing = 'false'; }
    }
  })
  .catch(err => console.error('Plate check error', err));
}

// Show UI notice for existing plate
function showPlateExistingNotice(customer, vehicle) {
  const container = document.getElementById('plateCheckResult');
  if (!container) return;
  container.dataset.existing = 'true';
  container.innerHTML = `
    <div class="alert alert-info d-flex justify-content-between align-items-center">
      <div>
        <strong>Existing Customer Found:</strong> ${customer.full_name} (${customer.phone})<br>
        <small class="text-muted">Vehicle: ${vehicle.plate} ${vehicle.make || ''} ${vehicle.model || ''}</small>
      </div>
      <div>
        <button type="button" class="btn btn-sm btn-primary me-2" onclick="useExistingCustomer(${customer.id})">Use Existing</button>
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="continueAsNew()">Continue as New</button>
      </div>
    </div>
  `;
}

function useExistingCustomer(customerId) {
  const container = document.getElementById('plateCheckResult');
  container.dataset.useExisting = 'true';
  container.dataset.existingCustomerId = String(customerId);
}

function continueAsNew() {
  const container = document.getElementById('plateCheckResult');
  container.dataset.useExisting = 'false';
  container.dataset.existingCustomerId = '';
}

// Auto-reset when modal shown
document.addEventListener('shown.bs.modal', function(e) {
  if (e.target.id === 'startOrderModal') {
    resetStartOrderForm();
  }
});

// Trigger plate check on blur
const plateInput = document.getElementById('plateNumber');
if (plateInput) {
  plateInput.addEventListener('blur', checkPlateExists);
}

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>
