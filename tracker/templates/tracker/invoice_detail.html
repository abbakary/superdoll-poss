{% extends 'tracker/base.html' %}
{% load static custom_filters %}

{% block title %}Invoice {{ invoice.invoice_number }}{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="page-title">
    <div class="row">
      <div class="col-6">
        <h4>Invoice {{ invoice.invoice_number }}</h4>
        <small class="text-muted">Status: <span class="badge bg-{% if invoice.status == 'draft' %}warning{% elif invoice.status == 'issued' %}info{% elif invoice.status == 'paid' %}success{% else %}danger{% endif %}">{{ invoice.get_status_display }}</span></small>
      </div>
      <div class="col-6">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{% url 'tracker:invoice_list' %}">Invoices</a></li>
          <li class="breadcrumb-item active">{{ invoice.invoice_number }}</li>
        </ol>
      </div>
    </div>
  </div>
</div>

<div class="container-fluid">
  <!-- Actions -->
  <div class="row mb-3">
    <div class="col-12">
      <div class="btn-group" role="group">
        <a href="{% url 'tracker:invoice_print' pk=invoice.pk %}" class="btn btn-outline-primary" target="_blank">
          <i class="fa fa-print me-1"></i>Print
        </a>
        {% if invoice.status == 'draft' or invoice.status == 'issued' %}
          <form method="post" action="{% url 'tracker:invoice_pdf' pk=invoice.pk %}" style="display:inline;">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-success">
              <i class="fa fa-file-pdf me-1"></i>Download PDF
            </button>
          </form>
        {% endif %}
        {% if invoice.status == 'draft' %}
          <form method="post" action="{% url 'tracker:invoice_finalize' pk=invoice.pk %}" style="display:inline;">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-info">
              <i class="fa fa-check me-1"></i>Finalize
            </button>
          </form>
        {% endif %}
        {% if invoice.status != 'cancelled' %}
          <form method="post" action="{% url 'tracker:invoice_cancel' pk=invoice.pk %}" style="display:inline;" onsubmit="return confirm('Are you sure?');">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-danger">
              <i class="fa fa-times me-1"></i>Cancel
            </button>
          </form>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Invoice Header -->
  <div class="row">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-light">
          <h6 class="mb-0">Customer Information</h6>
        </div>
        <div class="card-body">
          <strong>{{ invoice.customer.full_name }}</strong>
          <br><small class="text-muted">{{ invoice.customer.code }}</small>
          <div class="mt-3">
            <label class="form-label mb-1"><small>Phone</small></label>
            <p class="mb-0">{{ invoice.customer.phone }}</p>
          </div>
          {% if invoice.customer.email %}
          <div class="mt-2">
            <label class="form-label mb-1"><small>Email</small></label>
            <p class="mb-0">{{ invoice.customer.email }}</p>
          </div>
          {% endif %}
          {% if invoice.customer.address %}
          <div class="mt-2">
            <label class="form-label mb-1"><small>Address</small></label>
            <p class="mb-0">{{ invoice.customer.address }}</p>
          </div>
          {% endif %}
          {% if invoice.vehicle %}
          <div class="mt-3 pt-3 border-top">
            <label class="form-label mb-1"><small>Vehicle</small></label>
            <p class="mb-0">{{ invoice.vehicle.plate_number }} - {{ invoice.vehicle.make }} {{ invoice.vehicle.model }}</p>
          </div>
          {% endif %}
          {% if invoice.attended_by %}
          <div class="mt-2">
            <label class="form-label mb-1"><small>Attended By</small></label>
            <p class="mb-0">{{ invoice.attended_by }}</p>
          </div>
          {% endif %}
          {% if invoice.kind_attention %}
          <div class="mt-2">
            <label class="form-label mb-1"><small>Kind Attention</small></label>
            <p class="mb-0">{{ invoice.kind_attention }}</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-light">
          <h6 class="mb-0">Invoice Information</h6>
        </div>
        <div class="card-body">
          {% if invoice.seller_name %}
          <div class="mb-3">
            <h6 class="mb-1">Seller / Supplier</h6>
            <strong>{{ invoice.seller_name }}</strong>
            {% if invoice.seller_address %}
            <div class="small text-muted">{{ invoice.seller_address }}</div>
            {% endif %}
            {% if invoice.seller_phone %}
            <div class="small text-muted">Phone: {{ invoice.seller_phone }}</div>
            {% endif %}
            {% if invoice.seller_email %}
            <div class="small text-muted">Email: {{ invoice.seller_email }}</div>
            {% endif %}
            <hr/>
          </div>
          {% endif %}

          <div class="row mb-3">
            <div class="col-6">
              <label class="form-label mb-1"><small class="text-muted">Date</small></label>
              <p class="mb-0"><strong>{{ invoice.invoice_date|date:"d/m/Y" }}</strong></p>
            </div>
            <div class="col-6">
              <label class="form-label mb-1"><small class="text-muted">Due Date</small></label>
              <p class="mb-0">{{ invoice.due_date|date:"d/m/Y"|default:"Not set" }}</p>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label mb-1"><small class="text-muted">Reference</small></label>
            <p class="mb-0">{{ invoice.reference|default:"—" }}</p>
          </div>
          {% if invoice.order %}
          <div class="pt-3 border-top">
            <label class="form-label mb-1"><small class="text-muted">Related Order</small></label>
            <p class="mb-0"><a href="{% url 'tracker:started_order_detail' order_id=invoice.order.id %}">{{ invoice.order.order_number }}</a></p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  {% if invoice.document %}
  <div class="row mt-3">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <h6 class="mb-0"><i class="fa fa-paperclip me-2"></i>Uploaded Invoice Document</h6>
          <div class="btn-group btn-group-sm">
            <a href="{% url 'tracker:invoice_document_view' pk=invoice.id %}" target="_blank" class="btn btn-outline-secondary"><i class="fa fa-eye me-1"></i>View Inline</a>
            <a href="{% url 'tracker:invoice_document_download' pk=invoice.id %}" class="btn btn-outline-dark"><i class="fa fa-download me-1"></i>Download</a>
          </div>
        </div>
        <div class="card-body">
          <div class="alert alert-light mb-0"><i class="fa fa-info-circle me-2"></i>The original uploaded invoice file is attached to this invoice.</div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Line Items Section -->
  <div class="row mt-3">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <h6 class="mb-0">Line Items</h6>
          {% if invoice.status == 'draft' %}
          <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addLineItemModal">
            <i class="fa fa-plus me-1"></i>Add Item
          </button>
          {% endif %}
        </div>
        <div class="card-body">
          {% if invoice.line_items.all %}
          <div class="table-responsive">
            <table class="table table-sm table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th style="width: 80px;">Code</th>
                  <th>Description</th>
                  <th style="width: 100px;" class="text-end">Qty</th>
                  <th style="width: 120px;" class="text-end">Unit Price</th>
                  <th style="width: 100px;" class="text-end">VAT %</th>
                  <th style="width: 120px;" class="text-end">Total</th>
                  {% if invoice.status == 'draft' %}<th style="width: 60px;"></th>{% endif %}
                </tr>
              </thead>
              <tbody>
                {% for item in invoice.line_items.all %}
                <tr>
                  <td><small class="text-muted">{{ item.code|default:"—" }}</small></td>
                  <td>
                    <strong>{{ item.description }}</strong>
                    <br><small class="text-muted">{{ item.get_item_type_display }}{% if item.unit %} ({{ item.unit }}){% endif %}</small>
                  </td>
                  <td class="text-end">{{ item.quantity|format_qty }}</td>
                  <td class="text-end">{{ item.unit_price|floatformat:2 }}</td>
                  <td class="text-end">{{ item.tax_rate|floatformat:2 }}</td>
                  <td class="text-end"><strong>{{ item.line_total|floatformat:2 }}</strong></td>
                  {% if invoice.status == 'draft' %}
                  <td>
                    <form method="post" style="display:inline;" onsubmit="return confirm('Delete this item?');">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="delete_line_item">
                      <input type="hidden" name="item_id" value="{{ item.id }}">
                      <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete">
                        <i class="fa fa-trash"></i>
                      </button>
                    </form>
                  </td>
                  {% endif %}
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- Totals -->
          <div class="row mt-4">
            <div class="col-md-6 ms-auto">
              <table class="table table-sm table-borderless">
                <tr>
                  <td><strong>Subtotal</strong></td>
                  <td class="text-end"><strong>{{ invoice.subtotal|floatformat:2 }}</strong></td>
                </tr>
                {% if invoice.tax_amount > 0 %}
                <tr class="table-light">
                  <td>Tax{% if invoice.tax_rate > 0 %} ({{ invoice.tax_rate }}%){% endif %}</td>
                  <td class="text-end">{{ invoice.tax_amount|floatformat:2 }}</td>
                </tr>
                {% endif %}
                <tr class="table-light fw-bold border-top">
                  <td>TOTAL</td>
                  <td class="text-end text-success">{{ invoice.total_amount|floatformat:2 }}</td>
                </tr>
              </table>
            </div>
          </div>
          {% else %}
          <div class="alert alert-info mb-0">
            <i class="fa fa-info-circle me-2"></i>No line items yet. {% if invoice.status == 'draft' %}<button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addLineItemModal">Add Item</button>{% endif %}
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Payment Section -->
  <div class="row mt-3">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <h6 class="mb-0">Payment Information</h6>
          {% if invoice.status == 'draft' %}
          <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addPaymentModal">
            <i class="fa fa-plus me-1"></i>Add Payment
          </button>
          {% endif %}
        </div>
        <div class="card-body">
          {% if invoice.payment %}
          <div class="mb-3">
            <label class="form-label mb-1"><small class="text-muted">Method</small></label>
            <p class="mb-0"><strong>{{ invoice.payment.get_payment_method_display }}</strong></p>
          </div>
          <div class="mb-3">
            <label class="form-label mb-1"><small class="text-muted">Amount</small></label>
            <p class="mb-0"><strong>{{ invoice.payment.amount|floatformat:2 }}</strong></p>
          </div>
          {% if invoice.payment.payment_date %}
          <div class="mb-3">
            <label class="form-label mb-1"><small class="text-muted">Date</small></label>
            <p class="mb-0">{{ invoice.payment.payment_date|date:"d/m/Y" }}</p>
          </div>
          {% endif %}
          {% if invoice.payment.reference %}
          <div class="mb-3">
            <label class="form-label mb-1"><small class="text-muted">Reference</small></label>
            <p class="mb-0">{{ invoice.payment.reference }}</p>
          </div>
          {% endif %}
          {% else %}
          <div class="alert alert-info mb-0">
            <i class="fa fa-info-circle me-2"></i>No payment information yet. {% if invoice.status == 'draft' %}<button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addPaymentModal">Add Payment</button>{% endif %}
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-light">
          <h6 class="mb-0">Notes & Terms</h6>
        </div>
        <div class="card-body">
          {% if invoice.notes %}
          <div class="mb-3">
            <label class="form-label mb-1"><small class="text-muted">Notes</small></label>
            <p class="mb-0">{{ invoice.notes }}</p>
          </div>
          {% endif %}
          <div>
            <label class="form-label mb-1"><small class="text-muted">Terms</small></label>
            <p class="mb-0">
              {% if invoice.terms %}
                {{ invoice.terms }}
              {% else %}
                NOTE 1 : Payment in TSHS accepted at the prevailing rate on the date of payment. 2 : Proforma Invoice is Valid for 2 weeks from date of Proforma. 3 : Discount is Valid only for the above Quantity. 4 : Duty and VAT exemption documents to be submitted with the Purchase Order.
              {% endif %}
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Line Item Modal -->
<div class="modal fade" id="addLineItemModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Add Line Item</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="add_line_item">
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">{{ line_item_form.code.label }}</label>
              {{ line_item_form.code }}
              {% if line_item_form.code.errors %}<div class="text-danger f-12">{{ line_item_form.code.errors|striptags }}</div>{% endif %}
            </div>
            <div class="col-md-8">
              <label class="form-label">{{ line_item_form.description.label }}</label>
              {{ line_item_form.description }}
              {% if line_item_form.description.errors %}<div class="text-danger f-12">{{ line_item_form.description.errors|striptags }}</div>{% endif %}
            </div>
          </div>

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">{{ line_item_form.item_type.label }}</label>
              {{ line_item_form.item_type }}
              {% if line_item_form.item_type.errors %}<div class="text-danger f-12">{{ line_item_form.item_type.errors|striptags }}</div>{% endif %}
            </div>
            <div class="col-md-6">
              <label class="form-label">{{ line_item_form.inventory_item.label }}</label>
              {{ line_item_form.inventory_item }}
              <small class="text-muted">Optional: select from inventory</small>
              {% if line_item_form.inventory_item.errors %}<div class="text-danger f-12">{{ line_item_form.inventory_item.errors|striptags }}</div>{% endif %}
            </div>
          </div>

          <div class="row g-3 mt-2">
            <div class="col-md-4">
              <label class="form-label">{{ line_item_form.quantity.label }}</label>
              {{ line_item_form.quantity }}
              {% if line_item_form.quantity.errors %}<div class="text-danger f-12">{{ line_item_form.quantity.errors|striptags }}</div>{% endif %}
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ line_item_form.unit.label }}</label>
              {{ line_item_form.unit }}
              {% if line_item_form.unit.errors %}<div class="text-danger f-12">{{ line_item_form.unit.errors|striptags }}</div>{% endif %}
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ line_item_form.unit_price.label }}</label>
              {{ line_item_form.unit_price }}
              {% if line_item_form.unit_price.errors %}<div class="text-danger f-12">{{ line_item_form.unit_price.errors|striptags }}</div>{% endif %}
            </div>
          </div>
          <div class="row g-3 mt-2">
            <div class="col-md-4">
              <label class="form-label">{{ line_item_form.tax_rate.label }}</label>
              <div class="input-group">
                {{ line_item_form.tax_rate }}
                <span class="input-group-text">%</span>
              </div>
              {% if line_item_form.tax_rate.errors %}<div class="text-danger f-12">{{ line_item_form.tax_rate.errors|striptags }}</div>{% endif %}
              <small class="text-muted">Leave 0 for VAT-exempt items</small>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Item</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add Payment Modal -->
<div class="modal fade" id="addPaymentModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Add Payment Information</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="update_payment">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">{{ payment_form.payment_method.label }}</label>
            {{ payment_form.payment_method }}
            {% if payment_form.payment_method.errors %}<div class="text-danger f-12">{{ payment_form.payment_method.errors|striptags }}</div>{% endif %}
          </div>

          <div class="mb-3">
            <label class="form-label">{{ payment_form.amount.label }}</label>
            {{ payment_form.amount }}
            {% if payment_form.amount.errors %}<div class="text-danger f-12">{{ payment_form.amount.errors|striptags }}</div>{% endif %}
          </div>

          <div class="mb-3">
            <label class="form-label">{{ payment_form.payment_date.label }}</label>
            {{ payment_form.payment_date }}
            {% if payment_form.payment_date.errors %}<div class="text-danger f-12">{{ payment_form.payment_date.errors|striptags }}</div>{% endif %}
          </div>

          <div class="mb-3">
            <label class="form-label">{{ payment_form.reference.label }}</label>
            {{ payment_form.reference }}
            {% if payment_form.reference.errors %}<div class="text-danger f-12">{{ payment_form.reference.errors|striptags }}</div>{% endif %}
          </div>

          <div class="mb-3">
            <label class="form-label">{{ payment_form.notes.label }}</label>
            {{ payment_form.notes }}
            {% if payment_form.notes.errors %}<div class="text-danger f-12">{{ payment_form.notes.errors|striptags }}</div>{% endif %}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Payment</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
