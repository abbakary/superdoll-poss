{% extends 'tracker/base.html' %}
{% block title %}Customer Types{% endblock %}
{% block content %}
<div class="container-fluid">
  <div class="page-title mb-3">
    <div class="row">
      <div class="col-6"><h4>Customer Types & KPIs</h4></div>
      <div class="col-6 text-end">
        <div class="btn-group">
          <a href="?time_period=1month" class="btn btn-sm btn-outline-secondary">1M</a>
          <a href="?time_period=3months" class="btn btn-sm btn-outline-secondary">3M</a>
          <a href="?time_period=6months" class="btn btn-sm btn-primary">6M</a>
          <a href="?time_period=1year" class="btn btn-sm btn-outline-secondary">1Y</a>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <h6 class="text-muted">Total Customers</h6>
          <h3>{{ total_customers|default:0 }}</h3>
          <small class="text-muted">Active (30d): {{ active_customers_this_month|default:0 }}</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <h6 class="text-muted">Total Revenue</h6>
          <h3>{{ total_revenue|default:0 }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <h6 class="text-muted">Total Orders</h6>
          <h3>{{ total_orders|default:0 }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <h6 class="text-muted">Avg Revenue / Customer</h6>
          <h3>{{ overall_stats.avg_revenue_per_customer|default:0|floatformat:2 }}</h3>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    {% for code, grp in customer_groups.items %}
    <div class="col-md-6 col-lg-4 mb-3">
      <div class="card h-100 shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div>
            <strong>{{ grp.name }}</strong>
            <div class="small text-muted">{{ grp.total_customers }} customers</div>
          </div>
          <div class="text-end">
            <div class="fw-bold">{{ grp.stats.total_revenue|default:0 }}</div>
            <div class="small text-muted">Revenue</div>
          </div>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-6">
              <small class="text-muted">Orders</small>
              <div class="fw-bold">{{ grp.stats.total_orders|default:0 }}</div>
            </div>
            <div class="col-6 text-end">
              <small class="text-muted">Completion Rate</small>
              <div class="fw-bold">{{ grp.trends.completion_rate|default:0 }}%</div>
            </div>
          </div>
          <hr>
          <div class="small text-muted">Segmentation</div>
          <div class="d-flex gap-2 mt-2">
            <div class="p-2 bg-light rounded text-center flex-fill">
              <div class="fw-bold">{{ grp.segmentation.high_value }}</div>
              <small class="text-muted">High</small>
            </div>
            <div class="p-2 bg-light rounded text-center flex-fill">
              <div class="fw-bold">{{ grp.segmentation.medium_value }}</div>
              <small class="text-muted">Medium</small>
            </div>
            <div class="p-2 bg-light rounded text-center flex-fill">
              <div class="fw-bold">{{ grp.segmentation.low_value }}</div>
              <small class="text-muted">Low</small>
            </div>
          </div>
        </div>
        <div class="card-footer text-end">
          <a href="?group={{ grp.code }}" class="btn btn-sm btn-outline-primary">View Customers</a>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  {% if selected_group and detailed_customers %}
  <div class="row mt-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <h6 class="mb-0">Top Customers - {{ selected_group_display }}</h6>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr><th>Name</th><th>Orders</th><th>Total Spent</th><th>Last Order</th></tr>
              </thead>
              <tbody>
                {% for c in detailed_customers %}
                <tr>
                  <td><a href="{% url 'tracker:customer_detail' pk=c.id %}">{{ c.full_name }}</a></td>
                  <td>{{ c.recent_orders_count }}</td>
                  <td>{{ c.total_spent|default:0 }}</td>
                  <td>{{ c.last_order_date|date:'M d, Y' }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

</div>
{% endblock %}
